name: Build and Release Android APK

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'  # 在推送v开头的标签时触发发布
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git zip unzip openjdk-8-jdk autoconf libtool \
          pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev \
          cmake libffi-dev libssl-dev python3-dev \
          wget curl unzip tar

    - name: Install Buildozer and dependencies
      run: |
        python -m pip install --upgrade pip
        pip install buildozer cython virtualenv

    - name: Check project structure
      run: |
        echo "=== Project Structure ==="
        ls -la
        if [ -f main.py ]; then
          echo "main.py found"
        else
          echo "WARNING: main.py not found"
          find . -name "*.py" -type f | head -10
        fi

    - name: Initialize Buildozer if needed
      run: |
        if [ ! -f buildozer.spec ]; then
          echo "Initializing Buildozer..."
          buildozer init
          echo "=== Generated buildozer.spec ==="
          cat buildozer.spec | head -30
        else
          echo "=== Existing buildozer.spec ==="
          cat buildozer.spec | head -30
        fi

    - name: Configure Buildozer for CI environment
      run: |
        if [ -f buildozer.spec ]; then
          echo "Configuring Buildozer for CI..."
          sed -i 's/^#log_level = [0-9]/log_level = 2/' buildozer.spec || true
          sed -i 's/^log_level = [0-9]/log_level = 2/' buildozer.spec || true
          echo "Applied CI optimizations"
        fi

    - name: Build APK with detailed logging
      id: build
      timeout-minutes: 45
      run: |
        set -x
        echo "Starting Buildozer build..."
        
        export PATH=$PATH:~/.buildozer/android/platform/android-sdk/tools/bin
        
        buildozer android clean 2>&1 | tee -a build.log || true
        
        echo "=== Starting APK build ==="
        buildozer -v android debug 2>&1 | tee -a build.log || BUILD_EXIT_CODE=${PIPESTATUS[0]}
        
        if [ ${BUILD_EXIT_CODE:-0} -eq 0 ]; then
          echo "Build succeeded"
          echo "success=true" >> $GITHUB_OUTPUT
        else
          echo "Build failed with exit code: ${BUILD_EXIT_CODE}"
          echo "success=false" >> $GITHUB_OUTPUT
        fi

        if ls bin/*.apk 1> /dev/null 2>&1; then
          echo "APK files found:"
          ls -la bin/*.apk
          APK_FILE=$(ls bin/*.apk | head -1)
          echo "apk-file=${APK_FILE}" >> $GITHUB_OUTPUT
          echo "apk-exists=true" >> $GITHUB_OUTPUT
        else
          echo "No APK files found in bin/"
          echo "apk-exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Get version info
      id: version
      run: |
        if [ -f buildozer.spec ]; then
          VERSION=$(grep '^version' buildozer.spec | head -1 | cut -d'=' -f2 | tr -d ' ' || echo "0.1")
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
        else
          echo "version=0.1" >> $GITHUB_OUTPUT
        fi
        
        if [ -n "${{ github.ref_type }}" ] && [ "${{ github.ref_type }}" = "tag" ]; then
          echo "is-tag=true" >> $GITHUB_OUTPUT
          echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        else
          echo "is-tag=false" >> $GITHUB_OUTPUT
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "commit-sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
        fi

    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

    - name: Upload APK to GitHub Release
      if: steps.build.outputs.apk-exists == 'true' && steps.version.outputs.is-tag == 'true'
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ steps.build.outputs.apk-file }}
        body: |
          # APK Release - ${{ steps.version.outputs.tag }}
          
          ## Build Information
          - **Version:** ${{ steps.version.outputs.version }}
          - **Tag:** ${{ steps.version.outputs.tag }}
          - **Commit:** ${{ github.sha }}
          - **Build Date:** ${{ steps.date.outputs.date }}
          
          ## Installation
          1. Download the APK file
          2. Enable "Install from unknown sources" in Android settings
          3. Install the APK
          
          ## Notes
          This is an automated build from GitHub Actions.
        draft: false
        prerelease: ${{ contains(steps.version.outputs.tag, '-alpha') || contains(steps.version.outputs.tag, '-beta') || contains(steps.version.outputs.tag, '-rc') }}

    - name: Upload APK as artifact (for non-tag builds)
      if: steps.build.outputs.apk-exists == 'true' && steps.version.outputs.is-tag == 'false'
      uses: actions/upload-artifact@v4
      with:
        name: android-apk-${{ steps.version.outputs.commit-sha }}
        path: ${{ steps.build.outputs.apk-file }}
        retention-days: 30

    - name: Create pre-release for testing
      if: steps.build.outputs.apk-exists == 'true' && github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ steps.build.outputs.apk-file }}
        tag_name: test-build-${{ steps.version.outputs.commit-sha }}
        name: "Test Build - ${{ steps.version.outputs.commit-sha }}"
        body: |
          # Test Build
          
          This is a test build triggered manually via GitHub Actions.
          
          - **Commit:** ${{ steps.version.outputs.commit-sha }}
          - **Build Date:** ${{ steps.date.outputs.date }}
          
          This release will be automatically cleaned up after 7 days.
        draft: false
        prerelease: true

    - name: Debug build issues
      if: steps.build.outputs.success != 'true'
      run: |
        echo "=== Build Debug Information ==="
        find ~/.buildozer -type f -name "*.log" | head -10 2>/dev/null || echo "No buildozer logs found"
        
        if [ -f build.log ]; then
          echo "=== Last 100 lines of build log ==="
          tail -100 build.log
          
          echo "=== Error patterns in build log ==="
          grep -i -E "error|fail|exception|not found|missing" build.log | tail -30 || echo "No obvious errors found"
        fi

    - name: Upload build logs for debugging
      if: always() && steps.build.outputs.success != 'true'
      uses: actions/upload-artifact@v4
      with:
        name: build-debug-logs
        path: |
          build.log
          buildozer.spec
        retention-days: 7
